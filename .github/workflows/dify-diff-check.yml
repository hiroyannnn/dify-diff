name: Dify DSL Diff Check

on:
  pull_request:
    paths:
      - '**.yml'
      - '**.yaml'
      - '!**.norm.yml'  # .norm.yml ã®å¤‰æ›´ã§ã¯å®Ÿè¡Œã—ãªã„ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
      - '!.github/**'   # GitHub Actions ã® YAML ã‚’é™¤å¤–
    branches:
      - main
      - master

# åŒã˜ PR ã§è¤‡æ•°ã® workflow ãŒèµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write       # .norm.yml ã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦
  pull-requests: write  # PR ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ãŸã‚ã«å¿…è¦

jobs:
  normalize-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}  # PR ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆbase ã¨ã®æ¯”è¼ƒã®ãŸã‚ï¼‰

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r requirements.txt

      - name: ğŸ“‚ Find changed YAML files
        id: find-files
        run: |
          # main ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã§å¤‰æ›´ã•ã‚ŒãŸ YAML ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ï¼ˆ.norm.yml ã¨ .github/ ã‚’é™¤ãï¼‰
          BASE_SHA="${{ github.event.pull_request.base.sha }}"

          CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD | grep -E '\.(yml|yaml)$' | grep -v '\.norm\.yml$' | grep -v '^\.github/' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No YAML files changed"
            exit 0
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "ğŸ“„ Changed YAML files:"
          echo "$CHANGED_FILES"

      - name: ğŸ”„ Generate normalized files
        if: steps.find-files.outputs.no_changes != 'true'
        id: normalize
        run: |
          HAS_NEW_NORM=false

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              # .norm.yml ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆ.yml ã¾ãŸã¯ .yaml ã‚’ .norm.yml ã«ç½®æ›ï¼‰
              if [[ "$file" == *.yaml ]]; then
                NORM_FILE="${file%.yaml}.norm.yml"
              else
                NORM_FILE="${file%.yml}.norm.yml"
              fi

              echo "ğŸ”„ Normalizing $file â†’ $NORM_FILE"
              python scripts/normalize_dify.py "$file" "$NORM_FILE"

              # æ–°ã—ãç”Ÿæˆã•ã‚ŒãŸã‹ã€ã¾ãŸã¯å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if ! git diff --quiet "$NORM_FILE" 2>/dev/null; then
                HAS_NEW_NORM=true
              fi
            fi
          done <<< "${{ steps.find-files.outputs.changed_files }}"

          echo "has_new_norm=$HAS_NEW_NORM" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ Commit normalized files
        if: steps.normalize.outputs.has_new_norm == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add *.norm.yml
          git commit -m "chore: Update normalized DSL files [skip ci]" || echo "Nothing to commit"

          git push

          echo "âœ… Normalized files committed and pushed"

      - name: ğŸ’¬ Comment about normalization
        if: steps.normalize.outputs.has_new_norm == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = '## ğŸ”„ Dify DSL æ­£è¦åŒ–å®Œäº†\n\n' +
              'âœ… æ­£è¦åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`.norm.yml`ï¼‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚\n\n' +
              '### ğŸ“Š å·®åˆ†ã®ç¢ºèªæ–¹æ³•\n\n' +
              '1. **Files changed** ã‚¿ãƒ–ã‚’é–‹ã\n' +
              '2. `.norm.yml` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™\n' +
              '3. **UI ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆposition, selected ãªã©ï¼‰ãŒé™¤å¤–ã•ã‚ŒãŸå·®åˆ†**ã‚’ç¢ºèªã§ãã¾ã™\n\n' +
              '> ğŸ’¡ `.norm.yml` ã¯æ­£è¦åŒ–å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚å…ƒã® `.yml` ãƒ•ã‚¡ã‚¤ãƒ«ã¨ä¸¦ã¹ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n' +
              'â³ **LLM ã«ã‚ˆã‚‹æ„å‘³è§£æã‚’å®Ÿè¡Œä¸­...**\n';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: ğŸ“Š Generate diff for LLM analysis
        if: steps.normalize.outputs.has_new_norm == 'true'
        id: diff
        run: |
          mkdir -p diffs
          mkdir -p base_norm

          BASE_SHA="${{ github.event.pull_request.base.sha }}"

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              BASENAME=$(basename "$file")

              # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ‹¡å¼µå­ã‚’é™¤å»ã—ã¦ .norm.yml ã‚’ä»˜ä¸
              if [[ "$file" == *.yaml ]]; then
                NORM_FILE="${file%.yaml}.norm.yml"
                BASE_NAME="${BASENAME%.yaml}"
              else
                NORM_FILE="${file%.yml}.norm.yml"
                BASE_NAME="${BASENAME%.yml}"
              fi

              BASE_NORM_FILE="base_norm/${BASE_NAME}.norm.yml"
              DIFF_FILE="diffs/${BASE_NAME}_diff.txt"

              echo "ğŸ“Š Generating diff for $file..."

              # base ãƒ–ãƒ©ãƒ³ãƒã®å…ƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
              if git cat-file -e $BASE_SHA:"$file" 2>/dev/null; then
                # base ãƒ–ãƒ©ãƒ³ãƒã® .yml ã‚’å–å¾—
                echo "  ğŸ“¥ Fetching base version of $file..."
                git show $BASE_SHA:"$file" > "base_norm/${BASENAME}"

                # base ãƒ–ãƒ©ãƒ³ãƒã® .yml ã‚’æ­£è¦åŒ–
                echo "  ğŸ”„ Normalizing base version..."
                python scripts/normalize_dify.py "base_norm/${BASENAME}" "$BASE_NORM_FILE"

                # æ­£è¦åŒ–å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«åŒå£«ã‚’æ¯”è¼ƒ
                if [ -f "$NORM_FILE" ] && [ -f "$BASE_NORM_FILE" ]; then
                  echo "  âš–ï¸  Comparing normalized files..."
                  diff -u "$BASE_NORM_FILE" "$NORM_FILE" > "$DIFF_FILE" || true

                  if [ -s "$DIFF_FILE" ]; then
                    LINE_COUNT=$(wc -l < "$DIFF_FILE")
                    echo "  âœ… Diff generated: $DIFF_FILE ($LINE_COUNT lines)"
                  else
                    echo "  â„¹ï¸  No diff after normalization"
                    rm -f "$DIFF_FILE"
                  fi
                fi
              else
                # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯å…¨ä½“ã‚’ diff ã¨ã—ã¦æ‰±ã†
                echo "  â„¹ï¸  New file detected, treating as full addition"
                if [ -f "$NORM_FILE" ]; then
                  echo "--- /dev/null" > "$DIFF_FILE"
                  echo "+++ $NORM_FILE" >> "$DIFF_FILE"
                  cat "$NORM_FILE" | sed 's/^/+/' >> "$DIFF_FILE"
                  echo "  âœ… Diff generated: $DIFF_FILE (new file)"
                fi
              fi
            fi
          done <<< "${{ steps.find-files.outputs.changed_files }}"

          # ç”Ÿæˆã•ã‚ŒãŸå·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•°ã‚’ç¢ºèª
          DIFF_COUNT=$(ls -1 diffs/*_diff.txt 2>/dev/null | wc -l)
          echo "ğŸ“Š Total diffs generated: $DIFF_COUNT"

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "has_meaningful_diff=false" >> $GITHUB_OUTPUT
          else
            echo "has_meaningful_diff=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ¤– Analyze diff with LLM
        if: steps.diff.outputs.has_meaningful_diff == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LLM_MODEL: gpt-4o-mini
        run: |
          for diff_file in diffs/*_diff.txt; do
            if [ -f "$diff_file" ]; then
              echo "ğŸ¤– Analyzing $diff_file with LLM..."
              python scripts/llm_diff_analyzer.py "$diff_file" || echo "âš ï¸  LLM analysis failed for $diff_file"
            fi
          done

      - name: ğŸ’¬ Comment LLM analysis
        if: steps.diff.outputs.has_meaningful_diff == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const diffsDir = 'diffs';

            // diffs ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆ
            if (!fs.existsSync(diffsDir)) {
              console.log('No diffs directory found');
              return;
            }

            const analysisFiles = fs.readdirSync(diffsDir).filter(f => f.endsWith('_analysis.md'));

            if (analysisFiles.length === 0) {
              const comment = '## âš ï¸ LLM è§£æã‚¨ãƒ©ãƒ¼\n\n' +
                'LLM è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n' +
                '**è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :**\n' +
                '- `OPENAI_API_KEY` ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„\n' +
                '- API ã®ä½¿ç”¨é‡åˆ¶é™ã«é”ã—ã¦ã„ã‚‹\n' +
                '- OpenAI API ã«ä¸€æ™‚çš„ãªéšœå®³ãŒç™ºç”Ÿã—ã¦ã„ã‚‹\n\n' +
                '**å¯¾å‡¦æ–¹æ³•:**\n' +
                '1. GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets ã§ `OPENAI_API_KEY` ã‚’ç¢ºèª\n' +
                '2. OpenAI ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä½¿ç”¨é‡ã‚’ç¢ºèª\n' +
                '3. [OpenAI Status](https://status.openai.com/) ã§ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ã‚’ç¢ºèª\n\n' +
                '> ğŸ’¡ LLM è§£æãªã—ã§ã‚‚ã€**Files changed** ã‚¿ãƒ–ã§ `.norm.yml` ã®å·®åˆ†ã‚’ç¢ºèªã§ãã¾ã™ã€‚\n';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            } else {
              for (const analysisFile of analysisFiles) {
                const analysisPath = path.join(diffsDir, analysisFile);
                const analysisContent = fs.readFileSync(analysisPath, 'utf8');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: analysisContent
                });
              }
            }

      - name: âœ… No YAML files changed
        if: steps.find-files.outputs.no_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = '## â„¹ï¸ Dify DSL å·®åˆ†ãƒã‚§ãƒƒã‚¯\n\n' +
              'ã“ã®PRã§ã¯Dify DSLï¼ˆ`.yml`/`.yaml`ï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\n' +
              '_ãƒã‚§ãƒƒã‚¯å¯¾è±¡: `.yml`, `.yaml` ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`.norm.yml` ã‚’é™¤ãï¼‰_\n';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: â„¹ï¸ UI metadata only changes
        if: steps.find-files.outputs.no_changes != 'true' && steps.diff.outputs.has_meaningful_diff != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = '## âœ… Dify DSL å·®åˆ†ãƒã‚§ãƒƒã‚¯å®Œäº†\n\n' +
              '**çµæœ**: æ­£è¦åŒ–å¾Œã®å·®åˆ†ã¯ **0è¡Œ** ã§ã—ãŸã€‚\n\n' +
              '### ğŸ“Š åˆ¤å®šç†ç”±\n\n' +
              'ã“ã®PRã®å¤‰æ›´ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã§ã™ï¼š\n' +
              '- ğŸ¨ **UI ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ã®å¤‰æ›´**ï¼ˆ`position`, `selected`, `viewport` ãªã©ï¼‰\n' +
              '- ğŸ“ **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¿ã®å¤‰æ›´**ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã€æ”¹è¡Œãªã©ï¼‰\n\n' +
              '### âœ… å½±éŸ¿è©•ä¾¡\n\n' +
              '**å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã¸ã®å½±éŸ¿: ãªã—**\n\n' +
              'ã“ã‚Œã‚‰ã®å¤‰æ›´ã¯ Dify ã®å®Ÿè¡Œçµæœã«å½±éŸ¿ã—ã¾ã›ã‚“ã€‚å®‰å…¨ã«ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚\n\n' +
              '---\n\n' +
              '<details>\n' +
              '<summary>ğŸ“– è©³ç´°èª¬æ˜</summary>\n\n' +
              'æ­£è¦åŒ–å‡¦ç†ã§ã¯ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é™¤å¤–ã—ã¦ã„ã¾ã™ï¼š\n' +
              '- `position`, `positionAbsolute` - ãƒãƒ¼ãƒ‰ã®åº§æ¨™\n' +
              '- `width`, `height` - ãƒãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚º\n' +
              '- `selected`, `zIndex` - UI ã®é¸æŠçŠ¶æ…‹\n' +
              '- `viewport` - Canvas ã®è¡¨ç¤ºä½ç½®\n\n' +
              'ã“ã‚Œã‚‰ã‚’é™¤å¤–ã—ãŸçµæœã€å·®åˆ†ãŒãªããªã£ãŸãŸã‚ã€**UI ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã¿ã®å¤‰æ›´**ã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸã€‚\n' +
              '</details>\n';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: ğŸ“¤ Upload artifacts
        if: steps.diff.outputs.has_meaningful_diff == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dify-diff-analysis
          path: |
            diffs/
            base_norm/
          retention-days: 7
