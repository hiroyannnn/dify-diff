name: Dify DSL Diff Check

on:
  pull_request:
    paths:
      - '**.yml'
      - '**.yaml'
      - '!**.norm.yml'  # .norm.yml ã®å¤‰æ›´ã§ã¯å®Ÿè¡Œã—ãªã„ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
    branches:
      - main
      - master

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

# åŒã˜ PR ã§è¤‡æ•°ã® workflow ãŒèµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write       # .norm.yml ã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦
  pull-requests: write  # PR ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ãŸã‚ã«å¿…è¦

jobs:
  normalize-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}  # PR ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆbase ã¨ã®æ¯”è¼ƒã®ãŸã‚ï¼‰

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r requirements.txt

      - name: ğŸ“‚ Find changed YAML files
        id: find-files
        run: |
          # main ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã§å¤‰æ›´ã•ã‚ŒãŸ YAML ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ï¼ˆ.norm.yml ã‚’é™¤ãï¼‰
          BASE_SHA="${{ github.event.pull_request.base.sha }}"

          CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD | grep -E '\.(yml|yaml)$' | grep -v '\.norm\.yml$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No YAML files changed"
            exit 0
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "ğŸ“„ Changed YAML files:"
          echo "$CHANGED_FILES"

      - name: ğŸ”„ Generate normalized files
        if: steps.find-files.outputs.no_changes != 'true'
        id: normalize
        run: |
          HAS_NEW_NORM=false

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              # .norm.yml ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
              NORM_FILE="${file%.yml}.norm.yml"
              NORM_FILE="${NORM_FILE%.yaml}.norm.yml"

              echo "ğŸ”„ Normalizing $file â†’ $NORM_FILE"
              python scripts/normalize_dify.py "$file" "$NORM_FILE"

              # æ–°ã—ãç”Ÿæˆã•ã‚ŒãŸã‹ã€ã¾ãŸã¯å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if ! git diff --quiet "$NORM_FILE" 2>/dev/null; then
                HAS_NEW_NORM=true
              fi
            fi
          done <<< "${{ steps.find-files.outputs.changed_files }}"

          echo "has_new_norm=$HAS_NEW_NORM" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ Commit normalized files
        if: steps.normalize.outputs.has_new_norm == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add *.norm.yml
          git commit -m "chore: Update normalized DSL files [skip ci]" || echo "Nothing to commit"

          git push

          echo "âœ… Normalized files committed and pushed"

      - name: ğŸ’¬ Comment about normalization
        if: steps.normalize.outputs.has_new_norm == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = '## ğŸ”„ Dify DSL æ­£è¦åŒ–å®Œäº†\n\n' +
              'âœ… æ­£è¦åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`.norm.yml`ï¼‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚\n\n' +
              '### ğŸ“Š å·®åˆ†ã®ç¢ºèªæ–¹æ³•\n\n' +
              '1. **Files changed** ã‚¿ãƒ–ã‚’é–‹ã\n' +
              '2. `.norm.yml` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™\n' +
              '3. **UI ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆposition, selected ãªã©ï¼‰ãŒé™¤å¤–ã•ã‚ŒãŸå·®åˆ†**ã‚’ç¢ºèªã§ãã¾ã™\n\n' +
              '> ğŸ’¡ `.norm.yml` ã¯æ­£è¦åŒ–å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚å…ƒã® `.yml` ãƒ•ã‚¡ã‚¤ãƒ«ã¨ä¸¦ã¹ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n' +
              'â³ **LLM ã«ã‚ˆã‚‹æ„å‘³è§£æã‚’å®Ÿè¡Œä¸­...**\n';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: ğŸ“Š Generate diff for LLM analysis
        if: steps.normalize.outputs.has_new_norm == 'true'
        id: diff
        run: |
          mkdir -p diffs

          BASE_SHA="${{ github.event.pull_request.base.sha }}"

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              NORM_FILE="${file%.yml}.norm.yml"
              NORM_FILE="${NORM_FILE%.yaml}.norm.yml"

              if [ -f "$NORM_FILE" ]; then
                BASENAME=$(basename "$file")
                DIFF_FILE="diffs/${BASENAME%.yml}_diff.txt"

                echo "ğŸ“Š Generating diff for $NORM_FILE..."

                # base ãƒ–ãƒ©ãƒ³ãƒã® .norm.yml ã¨æ¯”è¼ƒ
                if git cat-file -e $BASE_SHA:"$NORM_FILE" 2>/dev/null; then
                  git diff $BASE_SHA HEAD -- "$NORM_FILE" > "$DIFF_FILE" || true
                else
                  # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯å…¨ä½“ã‚’ diff ã¨ã—ã¦æ‰±ã†
                  echo "--- /dev/null" > "$DIFF_FILE"
                  echo "+++ $NORM_FILE" >> "$DIFF_FILE"
                  cat "$NORM_FILE" | sed 's/^/+/' >> "$DIFF_FILE"
                fi

                if [ -s "$DIFF_FILE" ]; then
                  echo "âœ… Diff generated: $DIFF_FILE"
                else
                  rm "$DIFF_FILE"
                fi
              fi
            fi
          done <<< "${{ steps.find-files.outputs.changed_files }}"

      - name: ğŸ¤– Analyze diff with LLM
        if: steps.normalize.outputs.has_new_norm == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LLM_MODEL: gpt-4o-mini
        run: |
          for diff_file in diffs/*_diff.txt; do
            if [ -f "$diff_file" ]; then
              echo "ğŸ¤– Analyzing $diff_file with LLM..."
              python scripts/llm_diff_analyzer.py "$diff_file" || echo "âš ï¸  LLM analysis failed for $diff_file"
            fi
          done

      - name: ğŸ’¬ Comment LLM analysis
        if: steps.normalize.outputs.has_new_norm == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const diffsDir = 'diffs';

            // diffs ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆ
            if (!fs.existsSync(diffsDir)) {
              console.log('No diffs directory found');
              return;
            }

            const analysisFiles = fs.readdirSync(diffsDir).filter(f => f.endsWith('_analysis.md'));

            if (analysisFiles.length === 0) {
              const comment = '## âš ï¸ LLM è§£æã‚¨ãƒ©ãƒ¼\n\n' +
                'LLM è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n' +
                '**è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :**\n' +
                '- `OPENAI_API_KEY` ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„\n' +
                '- API ã®ä½¿ç”¨é‡åˆ¶é™ã«é”ã—ã¦ã„ã‚‹\n' +
                '- OpenAI API ã«ä¸€æ™‚çš„ãªéšœå®³ãŒç™ºç”Ÿã—ã¦ã„ã‚‹\n\n' +
                '**å¯¾å‡¦æ–¹æ³•:**\n' +
                '1. GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets ã§ `OPENAI_API_KEY` ã‚’ç¢ºèª\n' +
                '2. OpenAI ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä½¿ç”¨é‡ã‚’ç¢ºèª\n' +
                '3. [OpenAI Status](https://status.openai.com/) ã§ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ã‚’ç¢ºèª\n\n' +
                '> ğŸ’¡ LLM è§£æãªã—ã§ã‚‚ã€**Files changed** ã‚¿ãƒ–ã§ `.norm.yml` ã®å·®åˆ†ã‚’ç¢ºèªã§ãã¾ã™ã€‚\n';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            } else {
              for (const analysisFile of analysisFiles) {
                const analysisPath = path.join(diffsDir, analysisFile);
                const analysisContent = fs.readFileSync(analysisPath, 'utf8');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: analysisContent
                });
              }
            }

      - name: âœ… No changes detected
        if: steps.find-files.outputs.no_changes == 'true' || steps.normalize.outputs.has_new_norm != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = '## âœ… Dify DSL å·®åˆ†ãƒã‚§ãƒƒã‚¯å®Œäº†\n\n' +
              'æ­£è¦åŒ–å¾Œã®å·®åˆ†ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n\n' +
              '_UI ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ã®å¤‰æ›´ã€ã¾ãŸã¯å¤‰æ›´ãªã—_\n';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: ğŸ“¤ Upload artifacts
        if: steps.normalize.outputs.has_new_norm == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dify-diff-analysis
          path: diffs/
          retention-days: 7
